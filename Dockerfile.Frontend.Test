# ============================================
# Stage 1: Dependencies
# ============================================
FROM node:20-alpine AS dependencies
WORKDIR /app

# Copiar archivos de dependencias
COPY frontend/package*.json ./

# Instalar dependencias (incluyendo devDependencies)
RUN npm ci

# ============================================
# Stage 2: Build and Test
# ============================================
FROM node:20-alpine AS test
WORKDIR /app

# Copiar dependencias instaladas
COPY --from=dependencies /app/node_modules ./node_modules

# Copiar código fuente
COPY frontend/ ./

# Instalar herramientas adicionales para reportes
RUN apk add --no-cache \
    bash \
    curl

# Ejecutar linter
RUN echo "Running linter..." && \
    npm run lint || echo "Linting completed with warnings"

# Ejecutar tests con cobertura
RUN echo "Running tests with coverage..." && \
    npm run test:ci

# Verificar archivos generados
RUN echo "Verificando archivos generados:" && \
    ls -la . && \
    echo "" && \
    echo "Contenido de coverage/:" && \
    ls -la coverage/ || echo "No coverage directory" && \
    echo "" && \
    if [ -f coverage/cobertura-coverage.xml ]; then \
        echo "✅ cobertura-coverage.xml encontrado"; \
    else \
        echo "❌ cobertura-coverage.xml NO encontrado"; \
    fi

# Crear directorio para resultados
RUN mkdir -p /test-results

# Copiar resultados de tests y cobertura
RUN cp -r coverage /test-results/ 2>/dev/null || true
RUN cp test-results.xml /test-results/ 2>/dev/null || true

# ============================================
# Stage 3: Coverage Report
# ============================================
FROM node:20-alpine AS coverage-report
WORKDIR /app

# Copiar resultados de tests
COPY --from=test /test-results /test-results
COPY --from=test /app/coverage /coverage

# Instalar http-server para visualización
RUN npm install -g http-server

# Exponer puerto para visualización de reportes
EXPOSE 8080

# Comando para servir reportes
CMD ["http-server", "/coverage/lcov-report", "-p", "8080"]

# ============================================
# Stage 4: Final with all artifacts
# ============================================
FROM alpine:latest AS final
WORKDIR /testresults

# Copiar todos los resultados
COPY --from=test /test-results /testresults
COPY --from=test /app/coverage /testresults/coverage

# Mostrar resumen
CMD ["sh", "-c", "\
    echo '=========================================' && \
    echo '  FRONTEND TEST SUMMARY' && \
    echo '=========================================' && \
    echo '' && \
    ls -la /testresults/ && \
    echo '' && \
    if [ -f /testresults/coverage/coverage-summary.json ]; then \
        echo 'Coverage Summary:' && \
        cat /testresults/coverage/coverage-summary.json; \
    else \
        echo 'No coverage summary found'; \
    fi && \
    echo '' && \
    echo '=========================================' && \
    echo 'Tests executed successfully!' && \
    echo 'Coverage report: /testresults/coverage/lcov-report/index.html' && \
    echo '========================================='\
"]

